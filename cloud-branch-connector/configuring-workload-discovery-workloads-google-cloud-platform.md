# Configuring Workload Discovery for Workloads in Google Cloud Platform
Source: https://help.zscaler.com/cloud-branch-connector/configuring-workload-discovery-workloads-google-cloud-platform
PDF: https://help.zscaler.com/pdf/com/en/1531144.pdf

The workload discovery service is a Zscaler-managed service that discovers workloads in your Google Cloud Platform (GCP) account. The service also fetches associated metadata such as user-defined tags and attributes generated by cloud service providers. These tags and attributes are used in security policies.
Zscaler supports the following attributes:
- **labels**: The user-defined labels assigned to the virtual machine (VM)
- **tags**: The network tags applied to the VM
- **networkInterfaces.network**: The VPC network where the VM is running
- **networkInterfaces.subnetwork**: The subnetwork associated with the VM
- **serviceAccounts.email**: The service account attached to the VM instance
- **machineType**: The instance machine type (e.g., `n1-standard-4`)
- **zone**: The GCP zone in which the VM is running
- **disks.sourceImage**: The source image used to create the VM
Configuring the Workload Discovery Service in GCP
To enable the workload discovery service in GCP, onboard your GCP projects in the Zscaler Cloud & Branch Connector Admin Portal and configure your GCP environment to allow the Zscaler service to discover projects, discover workloads and associated metadata, and receive real-time notifications for VM start events. To learn more about configuring a GCP account, see [Adding a Google Cloud Platform Account](/cloud-branch-connector/adding-google-cloud-platform-account). To configure your GCP environment:
- [Create or Use an Existing Google Cloud Service Account](#create-gcp-service-account)
- [Grant IAM Access](#grant-iam-access)
- [Enable Google Cloud APIs](#step3)
- [Allow Service Account Impersonation](#service-account-impersonation)
- [Update the Cloud Connector Service Account](#step5)
After configuring your GCP environment, you can view or configure the following:
- [Project and Workload Asset Discovery](#project-discovery)
- [Real-Time VM Start Notifications](#vm-start-notifications)
[]
If you have an existing Google Cloud service account, assign the roles in the Permissions section. To create a new Google Cloud service account:
- Log in to the GCP console.
- From the left-side navigation, go to **IAM & Admin** > **Service Accounts**.
- Click **Create service account**.
- In the **Create service account** section, configure the following:
- **Service account name**: Enter a name for the service account.
- **Service account ID**: Enter your **Customer Service Account Email**.
- **Service account description**: Enter a description for the service account.
- Click **Done**.
[]
To select your scope:
- Log in to the GCP console.
- Go to IAM at the organization, folder, or project level.
- Click **Grant Access** and enter the service account email. To learn more, see [Adding a Google Cloud Platform Account](/cloud-branch-connector/adding-google-cloud-platform-account).
- Assign the following roles:
- Compute Viewer
- Cloud Asset Viewer
-
Browser
Only assign this role in the service account project.
- Click **Save**.
[]
The Zscaler service uses service account impersonation to securely access your GCP resources without long-lived credentials. To use the Zscaler viewer-style roles and impersonate with the **Service Account Token Creator** role, enable the following Google APIs per project:
- IAM Service Account Credentials API
- Cloud Resource Manager API
- Cloud Asset API
- Compute Engine API
If you don't enable the APIs, the workload discovery service does not function correctly regardless of your roles and permissions.
[]
To allow the workload discovery service to generate short-lived credentials and make GCP API calls, create or use a project service account with the required IAM roles:
- Log in to the GCP console.
- Go to **IAM & Admin** > **Service Accounts**.
- Select your service account.
- Click the **Permissions** tab.
- Click **Grant Access**.
- Enter the Zscaler service account email. To learn more, see [Adding a Google Cloud Platform Account](/cloud-branch-connector/adding-google-cloud-platform-account).
- Assign the **Service Account Token Creator** role.
- Click **Save**.
[]
Zscaler requires you to add the `roles/pubsub.editor` role to the Cloud Connector service account. Cloud Connector VMs use this role to receive workload delta messages when workload metadata changes.
[]
The workload discovery service can enumerate projects that you authorize by the roles or permissions you granted the service account at the organization, folder, or project level. It uses the `resourcemanager.projects.list` role to identify all onboarded projects, and it enables polling and metadata retrieval across multiple projects.
After discovering projects, the workload discovery service uses Compute Engine and other service APIs to:
- Retrieve VM and workload metadata.
- Map tags for security policy enforcement.
- Maintain an up-to-date inventory in the Zscaler cloud.
[]
By default, the workload discovery service polls every 5 minutes for changes. For near-instant updates, the workload discovery service supports pub/sub-based VM start notifications. You can enable the real-time VM start notification service by adding the `roles/pubsub.owner` and `roles/pubsub.viewer` roles to your Cloud Connector VM.
To set up real-time VM start notifications, ensure the following:
- **Pub/Sub Topic Creation**: Zscaler creates a pub/sub topic in the SaaS project.
- **Topic Sharing**: The topic is shared with your project using a resource policy.
- **Subscription in Customer Project**: The Cloud Connector VM subscribes using the `roles/pubsub.owner` role.
- **Logging Sink**: The logging sink captures `compute.instances.start` audit log events and publishes to the shared topic.
- **Zscaler Poll Trigger**: The poll trigger triggers immediate workload discovery.
Terraform Deployment Package
The Terraform deployment package is available in the Cloud & Branch Connector Admin Portal as a downloadable ZIP file. It contains `README.md` files in the directory for configuring and executing the deployment package. To learn more, see [Adding a Google Cloud Platform Account](/cloud-branch-connector/adding-google-cloud-platform-account).
The Terraform deployment package contains the following:
- **core_infra**: Creates service accounts, IAM roles, and logging sinks.
- **centralized_grants**: Grants cross-project workload discovery permissions.
The Terraform deployment package does the following:
- Automates the onboarding configuration for the workload discovery service.
- Creates and configures the service account with IAM roles.
- Grants impersonation rights to the Zscaler SaaS service account.
- Sets up logging sinks for VM start events.
- Configures pub/sub subscriptions for workload change events.